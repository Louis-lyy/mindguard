<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>MindGuard - MBTI + SAS Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tailwind & Font Awesome -->
  <script src="https://cdn.tailwindcss.com/3.4.3"></script>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <style>
    body {
      font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
      background-color: #f0f2f5;
      color: #1a202c;
    }

    .bento-box {
      background-color: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border-radius: 24px;
      padding: 1.5rem;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.05);
      border: 1px solid rgba(226, 232, 240, 0.5);
      transition: all 0.3s ease;
    }

    .bento-box:hover {
      transform: translateY(-4px);
      box-shadow: 0 14px 30px rgba(15, 23, 42, 0.15);
    }

    .btn-primary {
      background-image: linear-gradient(to right, #3b82f6 0%, #2563eb 50%, #3b82f6 100%);
      background-size: 200% auto;
      color: white;
      padding: 0.8rem 1.6rem;
      border-radius: 14px;
      font-weight: 600;
      border: none;
      transition: all 0.3s ease;
      box-shadow: 0 5px 18px -7px rgba(59, 130, 246, 0.6);
      font-size: 0.95rem;
    }

    .btn-primary:hover {
      background-position: right center;
      transform: translateY(-2px);
      box-shadow: 0 8px 20px -6px rgba(59, 130, 246, 0.8);
    }

    .btn-special {
      background-image: linear-gradient(to right, #10b981 0%, #059669 50%, #10b981 100%);
      background-size: 200% auto;
      color: white;
      padding: 0.7rem 1.3rem;
      border-radius: 12px;
      font-weight: 500;
      border: none;
      transition: all 0.3s ease;
      box-shadow: 0 5px 18px -7px rgba(16, 185, 129, 0.5);
      font-size: 0.9rem;
    }

    .btn-special:hover {
      background-position: right center;
      transform: translateY(-2px);
      box-shadow: 0 8px 20px -6px rgba(16, 185, 129, 0.7);
    }

    .chat-messages {
      max-height: calc(100vh - 320px);
      min-height: 260px;
      overflow-y: auto;
      padding-right: 8px;
    }

    .message {
      padding: 0.75rem 1rem;
      border-radius: 1.2rem;
      line-height: 1.55;
      font-size: 0.95rem;
      max-width: 80%;
      word-break: break-word;
    }

    .bot-message {
      background-color: #e0e7ff;
      color: #3730a3;
      border-bottom-left-radius: 0.4rem;
      align-self: flex-start;
    }

    .user-message {
      background-color: #3b82f6;
      color: #fff;
      border-bottom-right-radius: 0.4rem;
      align-self: flex-end;
    }

    .modal {
      background: rgba(15, 23, 42, 0.6);
      backdrop-filter: blur(8px);
    }

    .modal-content {
      background: white;
      padding: 1.5rem 1.75rem;
      border-radius: 24px;
      width: 100%;
      max-width: 780px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      border: 1px solid rgba(209, 213, 219, 0.5);
    }

    /* 简单的进度条样式：用于 MBTI */
    .mbti-progress-bg {
      width: 100%;
      height: 10px;
      border-radius: 999px;
      background: #e5e7eb;
      overflow: hidden;
    }

    .mbti-progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #3b82f6, #60a5fa);
      transition: width 0.25s ease;
    }

    /* 自定义滚动条 */
    .chat-messages::-webkit-scrollbar,
    #sasQuestionsContainer::-webkit-scrollbar,
    #mbtiQuestionsContainer::-webkit-scrollbar {
      width: 6px;
    }

    .chat-messages::-webkit-scrollbar-thumb,
    #sasQuestionsContainer::-webkit-scrollbar-thumb,
    #mbtiQuestionsContainer::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 999px;
    }
    /* 体验模式：隐藏落地页、直接展示主内容 */
    body.experience-mode #landingSection {
      display: none;
    }

    body.experience-mode #mainContent {
      opacity: 1 !important;
      pointer-events: auto !important;
      display: grid !important;
    }

    /* 着陆页时隐藏主内容，居中展示 */
    body:not(.experience-mode) #mainContent {
      display: none;
    }
  </style>
</head>

<body class="min-h-screen flex flex-col items-center p-3 md:p-6 bg-[#f5f6f8]">

<div class="w-full max-w-6xl mx-auto flex flex-col gap-6">
  <!-- 顶部标题（居中着陆页） -->
  <header id="landingSection" class="min-h-[70vh] flex flex-col items-center justify-center text-center space-y-6">
    <div>
    <h1 class="text-4xl md:text-5xl font-extrabold text-gray-800 tracking-tight">
      Mind<span class="text-blue-600">Guard</span>
    </h1>
      <p class="text-lg md:text-xl font-semibold text-gray-700 mt-3">
        智能伙伴｜Your AI Companion
      </p>
      <p class="text-sm md:text-base text-gray-500 mt-3">
        随时倾听，给予支持与洞察。探索自我，与 MindGuard 一同成长。<br class="hidden sm:block">
        Always listening, offering support and insights. Explore yourself and grow with MindGuard.
      </p>
    </div>
    <button id="startBtn" class="btn-primary px-7 py-3 rounded-2xl text-base shadow-md">
      开始体验 <i class="fas fa-arrow-right ml-2"></i>
    </button>
  </header>

  <!-- 主内容区 -->
<main id="mainContent"
      class="grid grid-cols-1 lg:grid-cols-3 gap-5 md:gap-6 opacity-0 pointer-events-none transition-all duration-500 mx-auto mt-12 md:mt-16">
    <!-- 左边：聊天 + 操作按钮 -->
    <section class="bento-box lg:col-span-2 flex flex-col">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h2 class="text-xl md:text-2xl font-bold text-gray-800">
            疗愈对话
            <span class="ml-2 text-xs font-light text-gray-500">HEALING CHAT</span>
          </h2>
          <p class="text-xs text-gray-500 mt-1">随时记录你的情绪与想法，AI 会温柔回应。</p>
        </div>
        <i class="fas fa-comments text-blue-500 text-2xl"></i>
      </div>

      <div id="chatMessages" class="chat-messages flex flex-col space-y-3 mb-4">
        <div class="message bot-message">
          你好呀，这里是 MindGuard。今天的你，想聊点什么？也可以点击右下角的
          <strong>MBTI 探索</strong> 或 <strong>焦虑自评（SAS）</strong> 按钮开始测评。
        </div>
      </div>

      <div class="mt-auto border-t pt-3">
        <div class="flex gap-3 items-end">
          <textarea id="userInput" rows="1"
                    class="flex-1 text-sm border border-gray-300 rounded-2xl px-3 py-2 resize-none focus:ring-2 focus:ring-blue-400 focus:border-blue-400"
                    placeholder="在这里输入你的想法或感受..."></textarea>
          <button id="sendBtn"
                  class="btn-primary flex items-center justify-center w-11 h-11 rounded-2xl">
            <i class="fas fa-paper-plane"></i>
          </button>
          <button id="mbtiBtn" class="btn-special flex items-center">
            <i class="fas fa-brain mr-1.5"></i> MBTI 探索
          </button>
        </div>
      </div>
    </section>

    <!-- 右边：结果卡片 -->
    <aside class="space-y-4 md:space-y-5">
      <!-- MBTI 结果 -->
      <div class="bento-box">
        <div class="flex justify-between items-center mb-3">
          <h2 class="text-lg font-semibold text-gray-800">
            个性洞察 <span class="ml-1 text-xs font-light text-gray-500">MBTI</span>
          </h2>
          <i class="fas fa-user-astronaut text-green-500 text-2xl"></i>
        </div>
        <p class="text-xs text-gray-500 mb-3">
          完成 MBTI 测试后，这里将展示你的 4 字母性格类型。
        </p>
        <div class="text-center py-3">
          <p class="text-3xl font-extrabold text-green-600" id="mbtiTypeDisplay">----</p>
          <p class="text-xs text-green-500 tracking-[0.2em]" id="mbtiTypeLabelEn">YOUR TYPE</p>
        </div>
      </div>

      <!-- 简易报告占位（可后续接 AI） -->
      <div class="bento-box">
        <div class="flex justify-between items-center mb-3">
          <h2 class="text-lg font-semibold text-gray-800">
            简要反馈 <span class="ml-1 text-xs font-light text-gray-500">SUMMARY</span>
          </h2>
          <i class="fas fa-file-medical-alt text-purple-500 text-2xl"></i>
        </div>
        <p id="summaryText" class="text-xs text-gray-600 leading-relaxed">
          暂无自动报告。当你完成 MBTI 与 SAS 测评后，我们会在此位置给出一个简要文字说明。
        </p>
      </div>

      <!-- 焦虑自评量表卡片 -->
      <div class="bento-box">
        <div class="flex justify-between items-center mb-3">
          <h2 class="text-lg font-semibold text-gray-800">
            焦虑自评量表 <span class="ml-1 text-xs font-light text-gray-500">SAS</span>
          </h2>
          <i class="fas fa-heartbeat text-orange-500 text-2xl"></i>
        </div>
        <p class="text-xs text-gray-600 mb-3">
          使用标准化 SAS 焦虑自评量表，了解最近一周你的焦虑水平。建议在安静、不被打扰的环境下完成。
        </p>
        <button id="sasBtn"
                class="btn-primary w-full bg-orange-500 hover:bg-orange-600">
          <i class="fas fa-notes-medical mr-1.5"></i> 开始焦虑自评（SAS）
        </button>
        <p class="text-[11px] text-gray-400 mt-2">
          结果仅供参考，并不等同于临床诊断。如有明显困扰或高分，请及时寻求专业心理帮助。
        </p>
      </div>
    </aside>
  </main>

<!-- 解压游戏 & 心理社区 -->
<section class="grid grid-cols-1 lg:grid-cols-2 gap-5 md:gap-6 w-full max-w-6xl mx-auto mt-6 md:mt-10">
  <div class="bento-box flex flex-col space-y-3">
    <div class="flex items-center justify-between">
      <div>
        <h3 class="text-lg font-semibold text-gray-800">解压游戏 <span class="text-xs font-light text-gray-500">Relaxing games</span></h3>
        <p class="text-sm text-gray-600 mt-1">通过轻松有趣的小游戏帮助放松心情、缓解压力，找回内心的平静与快乐。</p>
      </div>
      <i class="fas fa-gamepad text-blue-500 text-2xl"></i>
    </div>
    <div class="flex flex-wrap gap-2 text-xs">
      <span class="px-3 py-1 rounded-full bg-blue-50 text-blue-600">解压益智</span>
      <span class="px-3 py-1 rounded-full bg-green-50 text-green-600">放松冥想</span>
      <span class="px-3 py-1 rounded-full bg-orange-50 text-orange-600">趣味互动</span>
    </div>
    <button id="relaxStartBtn" class="btn-primary w-full justify-center">
      <i class="fas fa-play mr-2"></i> 开始游戏
    </button>
    <p class="text-[11px] text-gray-400">轻松小游戏，愉悦身心，享受片刻的美好时光。</p>
  </div>

  <div class="bento-box flex flex-col space-y-3">
    <div class="flex items-center justify-between">
      <div>
        <h3 class="text-lg font-semibold text-gray-800">心理社区 <span class="text-xs font-light text-gray-500">Community</span></h3>
        <p class="text-sm text-gray-600 mt-1">与志同道合的朋友分享心情，记录成长足迹，在这里找到社群的支持与陪伴。</p>
      </div>
      <i class="fas fa-users text-pink-500 text-2xl"></i>
    </div>
    <div class="flex flex-wrap gap-2 text-xs">
      <span class="px-3 py-1 rounded-full bg-pink-50 text-pink-600">心情分享</span>
      <span class="px-3 py-1 rounded-full bg-purple-50 text-purple-600">成长记录</span>
      <span class="px-3 py-1 rounded-full bg-yellow-50 text-yellow-600">互助交流</span>
    </div>
    <button id="communityBtn" class="btn-special w-full justify-center">
      <i class="fas fa-heart mr-2"></i> 进入社区
    </button>
    <p class="text-[11px] text-gray-400">尊重隐私，共同成长，保持友好与支持的氛围。</p>
  </div>
</section>

  <footer class="text-center text-xs text-gray-400 mt-8 mb-4">
    MindGuard Demo · 本页面仅用于前端交互演示，不构成任何专业医疗建议。
  </footer>
</div>

<!-- ============ MBTI 测试模态框 ============ -->
<div id="mbtiModal"
     class="modal fixed inset-0 z-40 hidden items-center justify-center p-4">
  <div class="modal-content max-h-[90vh] overflow-y-auto">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl md:text-2xl font-bold text-blue-600">
        MBTI 性格探索
      </h2>
      <button id="mbtiCloseBtn"
              class="text-gray-400 hover:text-gray-600 text-3xl leading-none">
        &times;
      </button>
    </div>

    <!-- 问题面板 -->
    <div id="mbtiQuestionPanel">
      <!-- 进度条（仅答题时显示） -->
    <div class="mb-3">
      <div class="flex justify-between text-xs text-gray-500 mb-1">
        <span id="mbtiProgressLabel">进度：0 / 8</span>
      </div>
      <div class="mbti-progress-bg">
        <div id="mbtiProgressBar" class="mbti-progress-bar"></div>
      </div>
    </div>

    <div id="mbtiQuestionsContainer" class="space-y-4 text-sm"></div>

      <div class="mt-5 flex flex-col gap-3">
        <div class="flex flex-col sm:flex-row gap-2">
          <button id="mbtiPrevBtn" class="btn-special flex-1 sm:flex-none px-4">
            上一题
          </button>
          <button id="mbtiNextBtn" class="btn-primary flex-1 sm:flex-none px-5">
            下一题
          </button>
      <button id="mbtiSubmitBtn"
                  class="btn-special flex-1 sm:flex-none px-6 hidden">
        提交并查看 MBTI 结果
      </button>
        </div>
      </div>
    </div>

    <!-- 结果面板 -->
    <div id="mbtiResultPanel" class="hidden bg-gray-50 border border-gray-200 rounded-2xl p-4 space-y-3">
      <div>
        <p class="text-xs text-gray-500">你的 MBTI 倾向</p>
        <p class="text-3xl font-extrabold text-blue-600" id="mbtiResultTypeLabel">----</p>
        <p class="text-[11px] text-gray-500" id="mbtiResultScores"></p>
      </div>
      <div class="text-sm text-gray-700 space-y-1">
        <p><strong>结果解读：</strong><span id="mbtiResultInterpretation"></span></p>
        <p><strong>适合工作：</strong><span id="mbtiResultWork"></span></p>
        <p><strong>人际建议：</strong><span id="mbtiResultSocial"></span></p>
      </div>
      <div class="flex flex-col sm:flex-row gap-2 pt-2">
        <button id="mbtiRetestQuick" class="btn-special flex-1">重新测 22 题</button>
        <button id="mbtiRetestFull" class="btn-primary flex-1">改做 90 题</button>
      </div>
    </div>

    <p id="mbtiResultText" class="text-sm text-gray-700 md:text-right flex-1 mt-3"></p>

    <p class="text-[11px] text-gray-400 mt-3 text-center">
      此版本仅作交互示例，不能等同于完整 MBTI 测验结果。
    </p>
  </div>
</div>

<!-- ============ SAS 焦虑自评量表模态框 ============ -->
<div id="sasModal"
     class="modal fixed inset-0 z-50 hidden items-center justify-center p-4">
  <div class="modal-content max-h-[90vh] overflow-y-auto">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl md:text-2xl font-bold text-orange-500">
        焦虑自评量表（SAS）
      </h2>
      <button id="sasCloseBtn"
              class="text-gray-400 hover:text-gray-600 text-3xl leading-none">
        &times;
      </button>
    </div>

    <p class="text-sm text-gray-600 mb-3">
      请根据你<strong>最近一周</strong>的实际感受，逐一回答下面每一道题目。每题只选一个最符合的选项。
    </p>

    <div id="sasQuestionsContainer" class="space-y-3 text-sm"></div>

    <div class="mt-5 flex flex-col gap-3">
      <div class="flex flex-col sm:flex-row gap-2">
        <button id="sasPrevBtn" class="btn-special flex-1 sm:flex-none px-4">
          上一题
        </button>
        <button id="sasNextBtn" class="btn-primary bg-orange-500 hover:bg-orange-600 flex-1 sm:flex-none px-5">
          下一题
        </button>
      <button id="sasSubmitBtn"
                class="btn-primary bg-orange-500 hover:bg-orange-600 flex-1 sm:flex-none px-6 hidden">
        <i class="fas fa-check-circle mr-1.5"></i> 提交并查看结果
      </button>
      </div>
      <p id="sasResultText" class="text-sm text-gray-700 md:text-right flex-1"></p>
    </div>

    <p class="text-[11px] text-gray-400 mt-3 text-center">
      本量表结果仅供参考，并不等同于临床诊断。如分数偏高或持续困扰，请尽快寻求专业心理帮助。
    </p>
  </div>
</div>

<!-- ============ MindEmoji 游戏模态框 ============ -->
<div id="mindEmojiModal"
     class="modal fixed inset-0 z-50 hidden items-center justify-center p-4">
  <div class="modal-content max-w-2xl w-full text-center">
    <div class="flex justify-end">
      <button id="mindEmojiClose"
              class="text-gray-400 hover:text-gray-600 text-3xl leading-none">
        &times;
      </button>
    </div>
    <div class="py-6 space-y-4">
      <h2 class="text-3xl md:text-4xl font-extrabold text-gray-800">
        MindEmoji <span class="text-blue-600">· 表情反应</span>
      </h2>
      <p class="text-sm md:text-base text-gray-500">
        轻松的小互动，放松情绪，和 MindEmoji 一起玩转表情。
      </p>
      <button id="mindEmojiStart"
              class="btn-primary px-8 py-3 rounded-xl text-base shadow-md">
        开始游戏
      </button>
    </div>
  </div>
</div>

<script>
  // ========== 简单聊天逻辑 ==========
  const chatMessages = document.getElementById('chatMessages');
  const userInput = document.getElementById('userInput');
  const sendBtn = document.getElementById('sendBtn');
  const landingSection = document.getElementById('landingSection');

  function addMessage(text, from = 'bot') {
    const div = document.createElement('div');
    div.classList.add('message', from === 'bot' ? 'bot-message' : 'user-message');
    div.textContent = text;
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  function handleSend() {
    const text = userInput.value.trim();
    if (!text) return;
    addMessage(text, 'user');
    userInput.value = '';
    setTimeout(() => {
      addMessage('我听到了你的分享。虽然这里还没有接入真正的大模型，但你可以先用 MBTI 与 SAS 测评来了解自己。', 'bot');
    }, 600);
  }

  sendBtn.addEventListener('click', handleSend);
  userInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  });

  // 自动高度
  userInput.addEventListener('input', function () {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 150) + 'px';
  });

  // ========== 主内容显隐 / 进入体验页面 ==========
  const startBtn = document.getElementById('startBtn');
  const mainContent = document.getElementById('mainContent');

  function enterExperienceMode(updateUrl = true) {
    document.body.classList.add('experience-mode');
    mainContent.classList.remove('pointer-events-none', 'opacity-0');
    mainContent.classList.add('opacity-100');
    startBtn.disabled = true;
    startBtn.textContent = '正在体验中';

    if (updateUrl) {
      const url = new URL(window.location.href);
      url.searchParams.set('view', 'experience');
      window.history.replaceState({}, '', url.toString());
    }

    chatMessages.scrollIntoView({ behavior: 'smooth' });
  }

  startBtn.addEventListener('click', () => {
    enterExperienceMode(true);
  });

  // 若 URL 携带 view=experience，则直接进入聊天/测评页面
  (() => {
    const params = new URLSearchParams(window.location.search);
    if (params.get('view') === 'experience') {
      enterExperienceMode(false);
    }
  })();

  // ========== MBTI 问卷（22题快速版 + 90题完整版） ==========
  const mbtiQuestionsQuick = [
    // 场景1：社交与精力
    { text: '忙碌一周后更想：', dim: 'EI', a: { label: '参加朋友聚会，通过交流放松', value: 'E' }, b: { label: '独自在家安静充电', value: 'I' } },
    { text: '解决复杂问题时，你倾向：', dim: 'EI', a: { label: '和团队讨论、头脑风暴', value: 'E' }, b: { label: '自己独立思考、钻研', value: 'I' } },
    { text: '与不熟悉的人交流时更常：', dim: 'EI', a: { label: '主动找话题、开启对话', value: 'E' }, b: { label: '先听对方说，再慢慢加入', value: 'I' } },
    { text: '去全新环境结识新朋友时：', dim: 'EI', a: { label: '感到兴奋和期待', value: 'E' }, b: { label: '有些犹豫，需要时间适应', value: 'I' } },

    // 场景2：信息收集
    { text: '接触新概念时更关注：', dim: 'SN', a: { label: '具体细节、实际用途', value: 'S' }, b: { label: '整体规律、潜在意义', value: 'N' } },
    { text: '阅读报告时更注意：', dim: 'SN', a: { label: '数据、事实和例子', value: 'S' }, b: { label: '结构、观点与含义', value: 'N' } },
    { text: '谈到未来，你更倾向：', dim: 'SN', a: { label: '基于现有信息务实规划', value: 'S' }, b: { label: '畅想多种可能性', value: 'N' } },
    { text: '描述一件事时，你常：', dim: 'SN', a: { label: '按时间顺序细节讲述', value: 'S' }, b: { label: '抓重点和核心思想跳跃讲述', value: 'N' } },

    // 场景3：决策与判断
    { text: '重要决策更依赖：', dim: 'TF', a: { label: '逻辑分析、权衡利弊', value: 'T' }, b: { label: '价值观与他人感受', value: 'F' } },
    { text: '评价观点时更容易：', dim: 'TF', a: { label: '指出逻辑或事实问题', value: 'T' }, b: { label: '关注是否合理、顾及人情', value: 'F' } },
    { text: '与人意见不一致时更常：', dim: 'TF', a: { label: '直接表达、用辩论说服', value: 'T' }, b: { label: '先找共同点、维持和谐', value: 'F' } },
    { text: '朋友求助时你更：', dim: 'TF', a: { label: '分析问题、给出方案', value: 'T' }, b: { label: '倾听感受、情感支持', value: 'F' } },
    { text: '做完决定后你通常：', dim: 'JP', a: { label: '觉得尘埃落定，继续前进', value: 'J' }, b: { label: '继续想是否有更好选择', value: 'P' } },

    // 场景4：生活方式与规划
    { text: '开始项目更喜欢：', dim: 'JP', a: { label: '先做详细计划再执行', value: 'J' }, b: { label: '先定方向再灵活调整', value: 'P' } },
    { text: '面对突发变化你常感到：', dim: 'JP', a: { label: '不安，希望恢复秩序', value: 'J' }, b: { label: '当作挑战或机会', value: 'P' } },
    { text: '日常安排更偏好：', dim: 'JP', a: { label: '井井有条、提前准备', value: 'J' }, b: { label: '保持弹性，随心决定', value: 'P' } },
    { text: '完成项目后你更：', dim: 'JP', a: { label: '满意收尾，喜欢结案', value: 'J' }, b: { label: '觉得还能改进或探索新可能', value: 'P' } },

    // 场景5：混合偏好
    { text: '感到压力时更倾向：', dim: 'EI', a: { label: '与朋友倾诉、寻求支持', value: 'E' }, b: { label: '自己思考、寻找内在方案', value: 'I' } },
    { text: '学习新技能更喜欢：', dim: 'SN', a: { label: '实践操作、摸索经验', value: 'S' }, b: { label: '先理解原理再系统学习', value: 'N' } },
    { text: '面对充满不确定性的项目：', dim: 'JP', a: { label: '兴奋并想尝试', value: 'P' }, b: { label: '犹豫，更爱明确计划的项目', value: 'J' } },
    { text: '做决定时你更：', dim: 'JP', a: { label: '快速判断并执行', value: 'J' }, b: { label: '先收集信息、多方考虑', value: 'P' } },
    { text: '合作时更关注：', dim: 'TF', a: { label: '任务效率与进度', value: 'T' }, b: { label: '团队感受与氛围', value: 'F' } },
  ];

  // 90题完整版（更全面）。约 15-20 分钟，请在有空时完成。
  const mbtiQuestionsFull = [
    // EI 22题
    { text: '参加社交活动时，你更倾向于主动打招呼并展开话题。', dim: 'EI', a: { label: '是，通常主动', value: 'E' }, b: { label: '否，更喜欢等待他人', value: 'I' } },
    { text: '遇到人多的聚会后，你更常感到充满能量而非疲惫。', dim: 'EI', a: { label: '是，越热闹越有劲', value: 'E' }, b: { label: '否，人多会消耗我', value: 'I' } },
    { text: '你习惯在会议中先开口表达观点，而不是先听完他人再说。', dim: 'EI', a: { label: '是，先说出想法', value: 'E' }, b: { label: '否，先听再说', value: 'I' } },
    { text: '新环境下，你会主动结识新朋友，而非只和熟人待在一起。', dim: 'EI', a: { label: '是，主动结识', value: 'E' }, b: { label: '否，先和熟人', value: 'I' } },
    { text: '在公开场合分享近况对你来说是自然的。', dim: 'EI', a: { label: '是，比较自然', value: 'E' }, b: { label: '否，会有点别扭', value: 'I' } },
    { text: '你更喜欢团队工作带来的讨论和互动，而不是单独工作。', dim: 'EI', a: { label: '是，偏好团队', value: 'E' }, b: { label: '否，更爱独立', value: 'I' } },
    { text: '当心情低落时，你更倾向于找人聊天释放情绪。', dim: 'EI', a: { label: '是，会找人聊', value: 'E' }, b: { label: '否，自己消化', value: 'I' } },
    { text: '参加陌生人的派对，你通常能很快融入氛围。', dim: 'EI', a: { label: '是，能很快融入', value: 'E' }, b: { label: '否，需要适应', value: 'I' } },
    { text: '与人交流时你会自然地使用大量手势和表情。', dim: 'EI', a: { label: '是，表达丰富', value: 'E' }, b: { label: '否，表达克制', value: 'I' } },
    { text: '长时间独处会让你觉得被困住或无聊。', dim: 'EI', a: { label: '是，会感到无聊', value: 'E' }, b: { label: '否，独处很舒服', value: 'I' } },
    { text: '演讲或发言前，你通常没有太多紧张。', dim: 'EI', a: { label: '是，较少紧张', value: 'E' }, b: { label: '否，会紧张', value: 'I' } },
    { text: '你喜欢把日常见闻分享在社交媒体或群聊中。', dim: 'EI', a: { label: '是，常常分享', value: 'E' }, b: { label: '否，很少分享', value: 'I' } },
    { text: '集体讨论中，你会不自觉地主导节奏或推动进展。', dim: 'EI', a: { label: '是，会推动', value: 'E' }, b: { label: '否，多半倾听', value: 'I' } },
    { text: '外出旅行时，你更喜欢结伴而非独行。', dim: 'EI', a: { label: '是，喜欢结伴', value: 'E' }, b: { label: '否，更爱独行', value: 'I' } },
    { text: '你愿意主动与陌生人寒暄（如排队、问路时）。', dim: 'EI', a: { label: '是，较主动', value: 'E' }, b: { label: '否，尽量避免', value: 'I' } },
    { text: '在团队庆祝或聚餐中，你通常很活跃。', dim: 'EI', a: { label: '是，很活跃', value: 'E' }, b: { label: '否，较安静', value: 'I' } },
    { text: '闲暇时间你更倾向参加社团、活动，而非待在家。', dim: 'EI', a: { label: '是，出门活动', value: 'E' }, b: { label: '否，更宅在家', value: 'I' } },
    { text: '面对突发的社交邀请，你大多欣然接受。', dim: 'EI', a: { label: '是，多半接受', value: 'E' }, b: { label: '否，常会推辞', value: 'I' } },
    { text: '与人合作做项目时，你喜欢频繁交流进度。', dim: 'EI', a: { label: '是，常交流', value: 'E' }, b: { label: '否，少交流', value: 'I' } },
    { text: '和朋友相处时，你常主动提出活动或话题。', dim: 'EI', a: { label: '是，主动提议', value: 'E' }, b: { label: '否，多随和', value: 'I' } },
    { text: '你倾向通过对话整理思路，而非先独自思考。', dim: 'EI', a: { label: '是，边聊边理思路', value: 'E' }, b: { label: '否，先想好再说', value: 'I' } },
    { text: '对你来说，“热闹”通常是正向词而非负担。', dim: 'EI', a: { label: '是，正向感受', value: 'E' }, b: { label: '否，容易疲惫', value: 'I' } },

    // SN 22题
    { text: '你更容易记住别人讲述的具体细节，而非抽象概念。', dim: 'SN', a: { label: '是，细节优先', value: 'S' }, b: { label: '否，概念优先', value: 'N' } },
    { text: '面对新课题，你会先寻找可操作的步骤而非原理框架。', dim: 'SN', a: { label: '是，先步骤', value: 'S' }, b: { label: '否，先框架', value: 'N' } },
    { text: '你做决定时更依赖已验证的数据与事实，而不是可能性推演。', dim: 'SN', a: { label: '是，依赖事实', value: 'S' }, b: { label: '否，重视推演', value: 'N' } },
    { text: '描述事物时，你倾向按时间顺序、逐条展开细节。', dim: 'SN', a: { label: '是，顺序细节', value: 'S' }, b: { label: '否，会跳跃提炼', value: 'N' } },
    { text: '学习时你更喜欢具体例子，而非从理论入手。', dim: 'SN', a: { label: '是，例子优先', value: 'S' }, b: { label: '否，理论先行', value: 'N' } },
    { text: '你会对可见的结果和实际落地更感兴趣，而非远期可能性。', dim: 'SN', a: { label: '是，更看重落地', value: 'S' }, b: { label: '否，更看重可能性', value: 'N' } },
    { text: '在回顾经历时，你通常记得当时的场景、人物和细节。', dim: 'SN', a: { label: '是，细节感强', value: 'S' }, b: { label: '否，更记得意义', value: 'N' } },
    { text: '规划工作时，你喜欢具体到每天或每步骤的安排。', dim: 'SN', a: { label: '是，细化步骤', value: 'S' }, b: { label: '否，保持大方向', value: 'N' } },
    { text: '你更信赖亲眼看到或亲自试过的东西。', dim: 'SN', a: { label: '是，亲测为主', value: 'S' }, b: { label: '否，可接受推演', value: 'N' } },
    { text: '听故事时，你更关注发生了什么，而不是作者想表达什么。', dim: 'SN', a: { label: '是，关注情节', value: 'S' }, b: { label: '否，关注含义', value: 'N' } },
    { text: '你偏好循序渐进而非跳跃式的学习路径。', dim: 'SN', a: { label: '是，循序渐进', value: 'S' }, b: { label: '否，跳跃探索', value: 'N' } },
    { text: '遇到新科技，你先关心能做什么具体事，而非未来场景。', dim: 'SN', a: { label: '是，先关心用途', value: 'S' }, b: { label: '否，先想象未来', value: 'N' } },
    { text: '处理信息时，你更倾向记录事实而非解读意图。', dim: 'SN', a: { label: '是，记录事实', value: 'S' }, b: { label: '否，解读意图', value: 'N' } },
    { text: '你容易注意到环境中的细微变化（布局、气味、声音）。', dim: 'SN', a: { label: '是，敏感细节', value: 'S' }, b: { label: '否，不太在意', value: 'N' } },
    { text: '在讨论未来时，你更倾向基于现有趋势做现实预测。', dim: 'SN', a: { label: '是，现实预测', value: 'S' }, b: { label: '否，开放想象', value: 'N' } },
    { text: '你喜欢把任务拆分成可执行的小块，而不是先画一张宏观蓝图。', dim: 'SN', a: { label: '是，拆分执行', value: 'S' }, b: { label: '否，先画蓝图', value: 'N' } },
    { text: '你更享受“把事情做正确”而非“发现全新路径”。', dim: 'SN', a: { label: '是，更爱做好', value: 'S' }, b: { label: '否，更爱创新', value: 'N' } },
    { text: '对你来说，“脚踏实地”比“跳出框架”更贴切。', dim: 'SN', a: { label: '是，更脚踏实地', value: 'S' }, b: { label: '否，更跳出框架', value: 'N' } },
    { text: '你更信赖有据可依的经验，而非直觉或灵感。', dim: 'SN', a: { label: '是，信赖经验', value: 'S' }, b: { label: '否，信赖直觉', value: 'N' } },
    { text: '审阅文档时，你会抓错别字、格式和数据准确性。', dim: 'SN', a: { label: '是，会挑细节', value: 'S' }, b: { label: '否，更看整体', value: 'N' } },
    { text: '你更喜欢已验证的方案，而非尝试未经验证的创意。', dim: 'SN', a: { label: '是，偏爱验证方案', value: 'S' }, b: { label: '否，愿意尝试创意', value: 'N' } },
    { text: '提到一件事时，你会把场景、颜色、人物具体描述出来。', dim: 'SN', a: { label: '是，会具体描写', value: 'S' }, b: { label: '否，更抽象总结', value: 'N' } },

    // TF 23题
    { text: '在冲突中，你更关注逻辑对错而非情感感受。', dim: 'TF', a: { label: '是，先看逻辑', value: 'T' }, b: { label: '否，更顾感受', value: 'F' } },
    { text: '给反馈时，你倾向直接指出问题而不是先肯定再建议。', dim: 'TF', a: { label: '是，直说问题', value: 'T' }, b: { label: '否，先肯定感受', value: 'F' } },
    { text: '决策时你更依赖客观标准而非个人或他人情绪。', dim: 'TF', a: { label: '是，客观标准', value: 'T' }, b: { label: '否，考虑情绪', value: 'F' } },
    { text: '面对请托，你会先评估是否合理而非担心对方失望。', dim: 'TF', a: { label: '是，先评估合理', value: 'T' }, b: { label: '否，会顾及失望', value: 'F' } },
    { text: '你更喜欢辩论式的讨论，而非情绪共鸣式的分享。', dim: 'TF', a: { label: '是，喜欢辩论', value: 'T' }, b: { label: '否，偏好共鸣', value: 'F' } },
    { text: '道歉时你更在意问题是否解决，而非对方是否感觉好受。', dim: 'TF', a: { label: '是，先看解决', value: 'T' }, b: { label: '否，更看感受', value: 'F' } },
    { text: '你倾向用数据或事实支撑观点，而非故事或隐喻。', dim: 'TF', a: { label: '是，用数据', value: 'T' }, b: { label: '否，用故事', value: 'F' } },
    { text: '遇到矛盾，你会先厘清标准，再考虑人情。', dim: 'TF', a: { label: '是，先标准', value: 'T' }, b: { label: '否，先人情', value: 'F' } },
    { text: '你希望别人对你直接坦率，而非委婉顾及。', dim: 'TF', a: { label: '是，直接坦率', value: 'T' }, b: { label: '否，委婉更好', value: 'F' } },
    { text: '你认为公平和一致性通常比灵活照顾个体更重要。', dim: 'TF', a: { label: '是，更重公平', value: 'T' }, b: { label: '否，更重体谅', value: 'F' } },
    { text: '当朋友倾诉时，你本能会给建议而非单纯陪伴。', dim: 'TF', a: { label: '是，给建议', value: 'T' }, b: { label: '否，先陪伴', value: 'F' } },
    { text: '你做选择时常用利弊列表，而非“感觉对不对”。', dim: 'TF', a: { label: '是，列利弊', value: 'T' }, b: { label: '否，凭感觉', value: 'F' } },
    { text: '团队中，你重视效率与目标达成甚于氛围。', dim: 'TF', a: { label: '是，更重效率', value: 'T' }, b: { label: '否，更重氛围', value: 'F' } },
    { text: '你更愿意听到批判性反馈，而不是鼓励为主的反馈。', dim: 'TF', a: { label: '是，批判更有用', value: 'T' }, b: { label: '否，鼓励更重要', value: 'F' } },
    { text: '你倾向把问题分解、找根因，而不是先安抚情绪。', dim: 'TF', a: { label: '是，先拆解问题', value: 'T' }, b: { label: '否，先安抚', value: 'F' } },
    { text: '面对不公时，你更愿意指出并纠正，而非保持和谐。', dim: 'TF', a: { label: '是，指出纠正', value: 'T' }, b: { label: '否，维护和谐', value: 'F' } },
    { text: '评价作品/方案时，你会直陈缺点。', dim: 'TF', a: { label: '是，直说缺点', value: 'T' }, b: { label: '否，会委婉', value: 'F' } },
    { text: '你希望对话“说重点”，而非围绕感受铺垫。', dim: 'TF', a: { label: '是，直奔重点', value: 'T' }, b: { label: '否，感受同样重要', value: 'F' } },
    { text: '在规则和关系冲突时，你更常选规则。', dim: 'TF', a: { label: '是，选规则', value: 'T' }, b: { label: '否，顾关系', value: 'F' } },
    { text: '做团队决策时，你会主张“对事不对人”。', dim: 'TF', a: { label: '是，坚持对事', value: 'T' }, b: { label: '否，会顾及人', value: 'F' } },
    { text: '你更容易被有逻辑的论证说服，而非情动或故事。', dim: 'TF', a: { label: '是，逻辑打动我', value: 'T' }, b: { label: '否，故事/情感打动我', value: 'F' } },
    { text: '冲突缓和后，你更在意问题是否解决而非关系气氛。', dim: 'TF', a: { label: '是，解决更重要', value: 'T' }, b: { label: '否，气氛更重要', value: 'F' } },
    { text: '当他人观点与你不同，你会理性拆解而非顺着感受。', dim: 'TF', a: { label: '是，理性拆解', value: 'T' }, b: { label: '否，会多体谅', value: 'F' } },

    // JP 23题
    { text: '日程安排中，你更喜欢提前计划而非临时决定。', dim: 'JP', a: { label: '是，提前计划', value: 'J' }, b: { label: '否，临时灵活', value: 'P' } },
    { text: '待办事项列表能让你安心，而不觉得受限。', dim: 'JP', a: { label: '是，列表助安心', value: 'J' }, b: { label: '否，觉得受限', value: 'P' } },
    { text: '你倾向按部就班完成任务，而非边做边调整方向。', dim: 'JP', a: { label: '是，按部就班', value: 'J' }, b: { label: '否，随时调整', value: 'P' } },
    { text: '面对变更，你会感到不适，需要时间重新组织。', dim: 'JP', a: { label: '是，会不适', value: 'J' }, b: { label: '否，变化带劲', value: 'P' } },
    { text: '做决定时，你更希望“定下来”而不是继续探索可能。', dim: 'JP', a: { label: '是，尽快定', value: 'J' }, b: { label: '否，继续开放', value: 'P' } },
    { text: '你喜欢把事情提早完成，而非接近截止才行动。', dim: 'JP', a: { label: '是，提前完成', value: 'J' }, b: { label: '否，接近截止', value: 'P' } },
    { text: '旅行前你会详细查好行程与备选方案。', dim: 'JP', a: { label: '是，详细查好', value: 'J' }, b: { label: '否，随走随看', value: 'P' } },
    { text: '你更喜欢有清晰标准的任务，而非开放式探索。', dim: 'JP', a: { label: '是，清晰标准', value: 'J' }, b: { label: '否，开放探索', value: 'P' } },
    { text: '工作时，你偏好先收尾当前任务再开始新任务。', dim: 'JP', a: { label: '是，先收尾', value: 'J' }, b: { label: '否，可并行切换', value: 'P' } },
    { text: '遇到突发安排，你会优先调整计划而非直接即兴。', dim: 'JP', a: { label: '是，先调整', value: 'J' }, b: { label: '否，直接即兴', value: 'P' } },
    { text: '你喜欢环境有序（桌面、文件命名），而非随性。', dim: 'JP', a: { label: '是，需要有序', value: 'J' }, b: { label: '否，随性即可', value: 'P' } },
    { text: '截止日期前，你通常已完成大部分任务。', dim: 'JP', a: { label: '是，提前完成', value: 'J' }, b: { label: '否，常接近DDL', value: 'P' } },
    { text: '你乐于制定规则或流程来提升效率。', dim: 'JP', a: { label: '是，愿意制定', value: 'J' }, b: { label: '否，流程束缚', value: 'P' } },
    { text: '当计划被打断时，你会花时间重排优先级。', dim: 'JP', a: { label: '是，会重排', value: 'J' }, b: { label: '否，继续随性', value: 'P' } },
    { text: '你更偏好明确的结论，而非“先放着再看”。', dim: 'JP', a: { label: '是，要结论', value: 'J' }, b: { label: '否，可先放着', value: 'P' } },
    { text: '你会为目标设定里程碑和检查点。', dim: 'JP', a: { label: '是，会设里程碑', value: 'J' }, b: { label: '否，不常设', value: 'P' } },
    { text: '突发灵感时，你会先记下排期，而非立即更改当前计划。', dim: 'JP', a: { label: '是，先排期', value: 'J' }, b: { label: '否，直接调整', value: 'P' } },
    { text: '你认为“有计划地自由”比“完全自由”更安心。', dim: 'JP', a: { label: '是，更安心', value: 'J' }, b: { label: '否，完全自由好', value: 'P' } },
    { text: '你喜欢把一天切分成明确的时间段来处理事务。', dim: 'JP', a: { label: '是，切分时间段', value: 'J' }, b: { label: '否，随时处理', value: 'P' } },
    { text: '遇到多选项时，你希望快速筛掉大部分并定案。', dim: 'JP', a: { label: '是，快筛快定', value: 'J' }, b: { label: '否，保留可能', value: 'P' } },
    { text: '你更在意按计划达成结果，而非探索过程中出现的新机会。', dim: 'JP', a: { label: '是，按计划达成', value: 'J' }, b: { label: '否，探索机会', value: 'P' } },
    { text: '完成一件事后，你喜欢“关档案”而不是留待以后再改。', dim: 'JP', a: { label: '是，关档案', value: 'J' }, b: { label: '否，保留弹性', value: 'P' } },
    { text: '你习惯把琐事安排在日程表里而不是随用随办。', dim: 'JP', a: { label: '是，安排日程', value: 'J' }, b: { label: '否，随用随办', value: 'P' } },
  ];

  const mbtiModal = document.getElementById('mbtiModal');
  const mbtiBtn = document.getElementById('mbtiBtn');
  const mbtiCloseBtn = document.getElementById('mbtiCloseBtn');
  const mbtiQuestionsContainer = document.getElementById('mbtiQuestionsContainer');
  const mbtiSubmitBtn = document.getElementById('mbtiSubmitBtn');
  const mbtiNextBtn = document.getElementById('mbtiNextBtn');
  const mbtiPrevBtn = document.getElementById('mbtiPrevBtn');
  const mbtiModeQuickBtn = document.getElementById('mbtiModeQuick'); // 已隐藏，仅保留兼容
  const mbtiModeFullBtn = document.getElementById('mbtiModeFull');   // 已隐藏，仅保留兼容
  const mbtiResultText = document.getElementById('mbtiResultText');
  const mbtiProgressBar = document.getElementById('mbtiProgressBar');
  const mbtiProgressLabel = document.getElementById('mbtiProgressLabel');
  const mbtiTypeDisplay = document.getElementById('mbtiTypeDisplay');
  const summaryText = document.getElementById('summaryText');
  const mbtiQuestionPanel = document.getElementById('mbtiQuestionPanel');
  const mbtiResultPanel = document.getElementById('mbtiResultPanel');
  const mbtiResultTypeLabel = document.getElementById('mbtiResultTypeLabel');
  const mbtiResultScores = document.getElementById('mbtiResultScores');
  const mbtiResultInterpretation = document.getElementById('mbtiResultInterpretation');
  const mbtiResultWork = document.getElementById('mbtiResultWork');
  const mbtiResultSocial = document.getElementById('mbtiResultSocial');
  const mbtiRetestQuick = document.getElementById('mbtiRetestQuick');
  const mbtiRetestFull = document.getElementById('mbtiRetestFull');
  let mbtiCurrentIndex = 0;
  let mbtiActiveQuestions = mbtiQuestionsQuick;
  let mbtiMode = 'quick'; // quick | full
  let mbtiAnswers = new Array(mbtiActiveQuestions.length).fill(null);

  function setMbtiMode(mode) {
    mbtiMode = mode;
    mbtiActiveQuestions = mode === 'full' ? mbtiQuestionsFull : mbtiQuestionsQuick;
    if (mbtiModeQuickBtn && mbtiModeFullBtn) {
      mbtiModeQuickBtn.classList.toggle('opacity-50', mode === 'full');
      mbtiModeFullBtn.classList.toggle('opacity-50', mode === 'quick');
      mbtiModeQuickBtn.classList.toggle('ring-2', mode === 'quick');
      mbtiModeFullBtn.classList.toggle('ring-2', mode === 'full');
      mbtiModeQuickBtn.classList.toggle('ring-blue-400', mode === 'quick');
      mbtiModeFullBtn.classList.toggle('ring-blue-400', mode === 'full');
    }
    mbtiCurrentIndex = 0;
    mbtiAnswers = new Array(mbtiActiveQuestions.length).fill(null);
    renderMbtiQuestion();
    mbtiResultPanel.classList.add('hidden');
    mbtiQuestionPanel.classList.remove('hidden');
  }

  function openMbtiModal() {
    setMbtiMode('quick'); // 默认打开22题
    mbtiResultText.textContent = '';
    mbtiModal.classList.remove('hidden');
    mbtiModal.classList.add('flex');
  }

  function closeMbtiModal() {
    mbtiModal.classList.add('hidden');
    mbtiModal.classList.remove('flex');
  }

  function renderMbtiQuestion() {
    const idx = mbtiCurrentIndex;
    const q = mbtiActiveQuestions[idx];
    mbtiQuestionsContainer.innerHTML = '';
      const wrapper = document.createElement('div');
      wrapper.className = 'p-3 md:p-4 rounded-xl bg-gray-50 border border-gray-200';
    const opts = [
      { key: 'a-strong', label: `非常符合：${q.a.label}`, value: q.a.value, weight: 2 },
      { key: 'a-soft', label: `比较符合：${q.a.label}`, value: q.a.value, weight: 1 },
      { key: 'neutral', label: '中性/看情况', value: 'NEUTRAL', weight: 0 },
      { key: 'b-soft', label: `比较符合：${q.b.label}`, value: q.b.value, weight: 1 },
      { key: 'b-strong', label: `非常符合：${q.b.label}`, value: q.b.value, weight: 2 },
    ];
      wrapper.innerHTML = `
      <p class="font-medium text-gray-800 mb-2">${idx + 1}. ${q.text}</p>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-xs md:text-sm" id="mbti-options"></div>
      `;
      mbtiQuestionsContainer.appendChild(wrapper);

    const optContainer = wrapper.querySelector('#mbti-options');
    opts.forEach((opt, i) => {
      const label = document.createElement('label');
      label.className = 'flex items-start space-x-2 cursor-pointer text-gray-600';
      label.innerHTML = `
        <input type="radio" name="mbti-q" value="${opt.value}|${opt.weight}"
               class="mt-1 text-blue-500 focus:ring-blue-400">
        <span>${opt.label}</span>
      `;
      optContainer.appendChild(label);
    });

    // 回填已选
    const saved = mbtiAnswers[idx];
    if (saved && saved.value) {
      const target = mbtiQuestionsContainer.querySelector(`input[value="${saved.value}|${saved.weight}"]`);
      if (target) target.checked = true;
    }

    // 监听单题选择
    mbtiQuestionsContainer.querySelectorAll('input[name="mbti-q"]').forEach((el) => {
      el.addEventListener('change', (e) => {
        const [v, w] = e.target.value.split('|');
        mbtiAnswers[idx] = { value: v, weight: Number(w) };
    updateMbtiProgress();
        updateMbtiControls();
      });
    });

    updateMbtiProgress();
    updateMbtiControls();
  }

  function updateMbtiProgress() {
    const total = mbtiActiveQuestions.length;
    const answered = mbtiAnswers.filter(Boolean).length;
    mbtiProgressLabel.textContent = `进度：${answered} / ${total}`;
    const percent = (answered / total) * 100;
    mbtiProgressBar.style.width = `${percent}%`;
  }

  function updateMbtiControls() {
    const atStart = mbtiCurrentIndex === 0;
    const atEnd = mbtiCurrentIndex === mbtiActiveQuestions.length - 1;
    mbtiPrevBtn.disabled = atStart;

    const answeredCurrent = !!mbtiAnswers[mbtiCurrentIndex];
    mbtiNextBtn.classList.toggle('hidden', atEnd);
    mbtiSubmitBtn.classList.toggle('hidden', !atEnd);

    mbtiNextBtn.disabled = !answeredCurrent;
    mbtiSubmitBtn.disabled = !answeredCurrent;
  }

  function goMbti(step) {
    const nextIndex = mbtiCurrentIndex + step;
    if (nextIndex < 0 || nextIndex >= mbtiActiveQuestions.length) return;
    mbtiCurrentIndex = nextIndex;
    renderMbtiQuestion();
  }

  function buildMbtiInsights(type) {
    const letters = type.split('');
    const pick = (char, optE, optI) => (char === 'E' ? optE : optI);
    const pickSN = (char) => (char === 'S' ? '务实、关注细节与当下体验' : '抽象、关注概念与未来可能');
    const pickTF = (char) => (char === 'T' ? '理性决策，强调逻辑与一致性' : '共情导向，重视人际与价值观');
    const pickJP = (char) => (char === 'J' ? '计划性强，喜欢确定性与收尾' : '灵活弹性，喜欢探索与保留选择');

    const interpretation = [
      pick(letters[0], '外向，偏好互动与表达', '内向，偏好独立与深度思考'),
      pickSN(letters[1]),
      pickTF(letters[2]),
      pickJP(letters[3]),
    ].join('；');

    let work = '';
    if (letters[1] === 'N' && letters[2] === 'T') {
      work = '策略/产品/研发/数据/咨询等需要抽象推理与逻辑决策的岗位';
    } else if (letters[1] === 'N' && letters[2] === 'F') {
      work = '创意/设计/教育/用户研究/心理相关岗位，兼顾想象与共情';
    } else if (letters[1] === 'S' && letters[2] === 'T') {
      work = '工程/质量/运营/供应链/财务/安规等强调事实与流程的岗位';
    } else {
      work = '客户成功/护理/行政/HR/社工/服务等重视人际与体验的岗位';
    }
    work += letters[3] === 'J'
      ? '，适合流程明确、节奏可预期的环境。'
      : '，适合探索式、节奏变化快的环境。';

    const social = [
      pick(letters[0], '保持倾听留白，给他人表达空间。', '主动表达需求与想法，减少信息缺口。'),
      pick(letters[2], '表达关心时放慢逻辑，多用感受性语言。', '表达立场时补充事实与理据，增加清晰度。'),
      pick(letters[3], '对变化预留缓冲，给自己和他人适应时间。', '与他人约定基本边界和时间点，避免反复变更。'),
    ].join(' ');

    return { interpretation, work, social };
  }

  function submitMbti() {
    const scores = { E: 0, I: 0, T: 0, F: 0, S: 0, N: 0, J: 0, P: 0 };
    const total = mbtiActiveQuestions.length;
    const unanswered = [];

    mbtiAnswers.forEach((val, idx) => {
      if (!val) {
        unanswered.push(idx + 1);
      } else {
        if (val.value !== 'NEUTRAL') {
          scores[val.value] += val.weight || 1;
        }
      }
    });

    if (unanswered.length) {
      alert(`还有 ${unanswered.length} 题未作答：第 ${unanswered.join(', ')} 题，请先完成。`);
      return;
    }

    const decideDim = (aScore, bScore, aChar, bChar) => {
      if (aScore === 0 && bScore === 0) return { char: '?', reason: `${aChar}/${bChar} 未判定（多选中性）` };
      if (aScore === bScore) return { char: '?', reason: `${aChar}/${bChar} 平分` };
      return { char: aScore > bScore ? aChar : bChar, reason: '' };
    };

    const dimEI = decideDim(scores.E, scores.I, 'E', 'I');
    const dimSN = decideDim(scores.S, scores.N, 'S', 'N');
    const dimTF = decideDim(scores.T, scores.F, 'T', 'F');
    const dimJP = decideDim(scores.J, scores.P, 'J', 'P');

    const unresolved = [dimEI, dimSN, dimTF, dimJP].filter(d => d.char === '?').map(d => d.reason);

    const type = `${dimEI.char}${dimSN.char}${dimTF.char}${dimJP.char}`;

    const modeLabel = mbtiMode === 'full' ? '（90题完整版，较全面）' : '（22题快速版，初步参考）';
    const insights = buildMbtiInsights(type);

    const dimScoreText =
      `维度计分：` +
      `E:${scores.E} / I:${scores.I}；` +
      `S:${scores.S} / N:${scores.N}；` +
      `T:${scores.T} / F:${scores.F}；` +
      `J:${scores.J} / P:${scores.P}`;

    const unresolvedText = unresolved.length
      ? `<br><span class="text-[12px] text-orange-600">未判定/平分：${unresolved.join('；')}，可减少“中性”选择或多选更倾向的一侧。</span>`
      : '';

    mbtiResultTypeLabel.textContent = type;
    mbtiResultScores.textContent = `${dimScoreText.replace('维度计分：', '')}${unresolved.length ? `；${unresolved.join('；')}` : ''}`;
    mbtiResultInterpretation.textContent = insights.interpretation;
    mbtiResultWork.textContent = insights.work;
    mbtiResultSocial.textContent = insights.social;
    mbtiResultText.textContent = '';
    mbtiTypeDisplay.textContent = type;
    summaryText.textContent =
      `你的 MBTI 倾向为 ${type}${mbtiMode === 'full' ? '（完整版 90 题）' : '（快速版 22 题）'}。`;

    mbtiQuestionPanel.classList.add('hidden');
    mbtiResultPanel.classList.remove('hidden');
  }

  mbtiBtn.addEventListener('click', openMbtiModal);
  mbtiCloseBtn.addEventListener('click', closeMbtiModal);
  mbtiModal.addEventListener('click', (e) => {
    if (e.target === mbtiModal) closeMbtiModal();
  });
  // 顶部模式按钮已隐藏，若存在则仍可切换
  if (mbtiModeQuickBtn) mbtiModeQuickBtn.addEventListener('click', () => setMbtiMode('quick'));
  if (mbtiModeFullBtn) mbtiModeFullBtn.addEventListener('click', () => setMbtiMode('full'));
  mbtiNextBtn.addEventListener('click', () => goMbti(1));
  mbtiPrevBtn.addEventListener('click', () => goMbti(-1));
  mbtiSubmitBtn.addEventListener('click', submitMbti);
  mbtiRetestQuick.addEventListener('click', () => {
    setMbtiMode('quick');
    mbtiModal.scrollTop = 0;
  });
  mbtiRetestFull.addEventListener('click', () => {
    setMbtiMode('full');
    mbtiModal.scrollTop = 0;
  });

  // ========== SAS 焦虑自评量表 ==========
  const sasQuestions = [
    "我感到紧张或不安。",
    "我无缘无故地感到害怕或恐惧。",
    "我容易恼怒或烦躁。",
    "我有一种不祥的预感，好像将有不幸的事情发生。",
    "我容易心里发慌。",
    "我感到平静、踏实。",
    "我感到手脚发抖或发软。",
    "我容易因为一点小事就出汗（如手心出汗等）。",
    "我感到心跳加快或心慌。",
    "我容易感到头昏或站立不稳。",
    "我容易因为一点小事就紧张不安。",
    "我睡眠不安或难以入睡。",
    "我做恶梦或从梦中惊醒。",
    "我容易受到惊吓（比如突然的声音）。",
    "我觉得自己容易疲劳、没精神。",
    "我感到胃口不好或消化不良。",
    "我经常感到口干舌燥。",
    "我感到身体某些部位有发麻、刺痛等异常感觉。",
    "我感到需要别人不断地安慰或肯定。",
    "即使放松下来，我也很难真正感到轻松愉快。"
  ];

  const sasModal = document.getElementById('sasModal');
  const sasBtn = document.getElementById('sasBtn');
  const sasCloseBtn = document.getElementById('sasCloseBtn');
  const sasQuestionsContainer = document.getElementById('sasQuestionsContainer');
  const sasSubmitBtn = document.getElementById('sasSubmitBtn');
  const sasNextBtn = document.getElementById('sasNextBtn');
  const sasPrevBtn = document.getElementById('sasPrevBtn');
  const sasResultText = document.getElementById('sasResultText');
  const relaxStartBtn = document.getElementById('relaxStartBtn');
  const mindEmojiModal = document.getElementById('mindEmojiModal');
  const mindEmojiClose = document.getElementById('mindEmojiClose');
  const mindEmojiStart = document.getElementById('mindEmojiStart');
  const mindEmojiUrl = 'https://aigchacker.com/mind-game.html'; // 直接跳转到线上游戏
  const communityBtn = document.getElementById('communityBtn');
  const communityUrl = 'https://aigchacker.com/mind-community.html';
  let sasCurrentIndex = 0;
  let sasAnswers = new Array(sasQuestions.length).fill(null);

  function renderSasQuestion() {
    const idx = sasCurrentIndex;
    const q = sasQuestions[idx];
    sasQuestionsContainer.innerHTML = '';
      const block = document.createElement('div');
      block.className = 'p-3 md:p-4 rounded-xl bg-gray-50 border border-gray-200';

      block.innerHTML = `
      <p class="font-medium text-gray-800 mb-2">${idx + 1}. ${q}</p>
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-2 text-xs md:text-sm">
          <label class="flex items-center space-x-2 cursor-pointer text-gray-600">
          <input type="radio" name="sas-q" value="1"
                   class="text-orange-500 focus:ring-orange-400">
            <span>1分：没有或很少时间</span>
          </label>
          <label class="flex items-center space-x-2 cursor-pointer text-gray-600">
          <input type="radio" name="sas-q" value="2"
                   class="text-orange-500 focus:ring-orange-400">
            <span>2分：小部分时间</span>
          </label>
          <label class="flex items-center space-x-2 cursor-pointer text-gray-600">
          <input type="radio" name="sas-q" value="3"
                   class="text-orange-500 focus:ring-orange-400">
            <span>3分：相当多时间</span>
          </label>
          <label class="flex items-center space-x-2 cursor-pointer text-gray-600">
          <input type="radio" name="sas-q" value="4"
                   class="text-orange-500 focus:ring-orange-400">
            <span>4分：绝大部分或全部时间</span>
          </label>
        </div>
      `;
      sasQuestionsContainer.appendChild(block);

    const saved = sasAnswers[idx];
    if (saved) {
      const target = sasQuestionsContainer.querySelector(`input[value="${saved}"]`);
      if (target) target.checked = true;
    }

    sasQuestionsContainer.querySelectorAll('input[name="sas-q"]').forEach((el) => {
      el.addEventListener('change', (e) => {
        sasAnswers[idx] = e.target.value;
        updateSasControls();
      });
    });

    updateSasControls();
  }

  function updateSasControls() {
    const atStart = sasCurrentIndex === 0;
    const atEnd = sasCurrentIndex === sasQuestions.length - 1;
    sasPrevBtn.disabled = atStart;
    const answeredCurrent = !!sasAnswers[sasCurrentIndex];
    sasNextBtn.classList.toggle('hidden', atEnd);
    sasSubmitBtn.classList.toggle('hidden', !atEnd);
    sasNextBtn.disabled = !answeredCurrent;
    sasSubmitBtn.disabled = !answeredCurrent;
  }

  function goSas(step) {
    const nextIndex = sasCurrentIndex + step;
    if (nextIndex < 0 || nextIndex >= sasQuestions.length) return;
    sasCurrentIndex = nextIndex;
    renderSasQuestion();
  }

  function openSasModal() {
    sasCurrentIndex = 0;
    sasAnswers = new Array(sasQuestions.length).fill(null);
    renderSasQuestion();
    sasResultText.textContent = '';
    sasModal.classList.remove('hidden');
    sasModal.classList.add('flex');
  }

  function closeSasModal() {
    sasModal.classList.add('hidden');
    sasModal.classList.remove('flex');
  }

  function submitSasTest() {
    let total = 0;
    let unanswered = [];
    sasAnswers.forEach((val, idx) => {
      if (!val) {
        unanswered.push(idx + 1);
      } else {
        total += Number(val);
      }
    });

    if (unanswered.length) {
      alert(`还有 ${unanswered.length} 题未作答：第 ${unanswered.join(', ')} 题，请先完成。`);
      return;
    }

    const rawScore = total;
    const standardScore = Math.round(rawScore * 1.25);

    let level = '';
    let advice = '';

    if (standardScore < 50) {
      level = '正常范围';
      advice = '当前整体焦虑水平在正常范围内，继续保持良好的作息与自我关怀即可。';
    } else if (standardScore < 60) {
      level = '轻度焦虑';
      advice = '可能存在轻度焦虑反应，建议关注休息与压力管理，如放松训练、适度运动。';
    } else if (standardScore < 70) {
      level = '中度焦虑';
      advice = '焦虑程度已有一定影响，建议尽快与专业心理咨询师或精神科医生沟通评估。';
    } else {
      level = '重度焦虑';
      advice = '焦虑程度较重，强烈建议尽快前往专业医疗机构进行评估与干预。';
    }

    sasResultText.innerHTML =
      `标准分：<span class="font-semibold text-orange-500">${standardScore}</span>（原始分：${rawScore}）<br>` +
      `焦虑水平：<span class="font-semibold">${level}</span>。${advice}`;

    summaryText.textContent =
      `你已完成 SAS 焦虑自评，标准分约为 ${standardScore} 分，属于「${level}」。请将结果视为提醒，而不是标签，必要时及时寻求专业帮助。`;

    addMessage(`你的 SAS 标准分为 ${standardScore}，焦虑水平大致为「${level}」。请善待自己的情绪，也可以考虑和专业人士聊一聊。`, 'bot');
  }

  sasBtn.addEventListener('click', openSasModal);
  sasCloseBtn.addEventListener('click', closeSasModal);
  sasModal.addEventListener('click', (e) => {
    if (e.target === sasModal) closeSasModal();
  });
  sasNextBtn.addEventListener('click', () => goSas(1));
  sasPrevBtn.addEventListener('click', () => goSas(-1));
  sasSubmitBtn.addEventListener('click', submitSasTest);

  // ========== MindEmoji 游戏：新窗口跳转 ==========
  relaxStartBtn.addEventListener('click', () => {
    window.open(mindEmojiUrl, '_blank', 'noopener,noreferrer');
  });
  mindEmojiStart.addEventListener('click', () => {
    window.open(mindEmojiUrl, '_blank', 'noopener,noreferrer');
  });

  // ========== 心理社区 ==========
  communityBtn.addEventListener('click', () => {
    window.open(communityUrl, '_blank', 'noopener,noreferrer');
  });
</script>
</body>
</html>